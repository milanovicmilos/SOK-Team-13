{% block head_sadrzaj %}
<style>

.node {
  cursor: pointer;
  color: #046ebd;

}

.link {
  fill: none;
  stroke: #046ebd;
  stroke-width: 1.5px;
}

</style>
<script>
    function nodeClick(el){
       alert("ID: "+el.id);
    }
</script>
{% endblock %}
{% block content %}
<div>
    <svg width="500" height="500">

    </svg>
</div>
<script>
    // Cvorovi grafa predstavljalu prodavnice i artikli.
    var nodes = {
        {% for  node in graph.nodes %}
            "{{ node.node_id }}": {{ node.parsed_data }},
        {% endfor %}
    };


    function urlToValidId(url) {
        // Replace invalid characters with underscores
        return url.replace(/[^a-zA-Z0-9-_]/g, '_');
    }

    function urlToValidName(url) {
        const regex = /([^\/#]+)(?:\/([^#]+))?#([^#]+)?$/;
        const match = url.match(regex);

        if (match) {
            const [, lastSegment, innerSegment, lastHashSegment] = match;
            return lastHashSegment ? lastHashSegment : innerSegment ? innerSegment : lastSegment;
        }

        // If there's no match, return the original URL
        return url;
    }


    var links=[
        {% for edge in graph.edges %}
            {
              source: "{{ edge.source_node.node_id }}",
              target: "{{ edge.target_node.node_id }}"},
        {% endfor %}
    ];

    links.forEach(function(link) {
        link.source = nodes[link.source];
        link.target = nodes[link.target];
    });
    // Force layout vrsi numericku simulaciju n-tela (n-cestica).
    // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/
    var force = d3.layout.force() // kreiranje force layout-a
        .size([400, 400]) // raspoloziv prostor za iscrtavanje
        .nodes(d3.values(nodes)) // dodavanje informacija o cvorovima grafa
        .links(links) // dodavanje informacije o ivicama grafa
        .on("tick", tick)
        .linkDistance(300) // duzina ivice grafa
        .charge(-100) // koliko da se elementi odbijaju (pozitivna vrednost kaze koliko se elementi privlace)
        .start(); //pokreni simulaciju

    var svg=d3.select('svg');

    // Stvarno iscrtavanje linkova koji su prikazani linijama.
    var link = svg.selectAll('.link')
        .data(links)
        .enter().append('line')
        .attr('class', 'link')
        .attr('x1', function(d) { return d.source.y; })
        .attr('y1', function(d) { return d.source.x; })
        .attr('x2', function(d) { return d.target.y; })
        .attr('y2', function(d) { return d.target.x; });

    // Stvarno iscrtavanje cvorova reprezentovanih g tagom.
    var node = svg.selectAll('.node')
        .data(force.nodes()) //add
        .enter().append('g')
        .attr('class', 'node')
        .attr('id', function(d) { return urlToValidId(d.id); })
        .on('click',function(){
           nodeClick(this);
        });


    // Sadrzaj svakog g taga iscrtavamo funkcijom slozenPrikaz.
    d3.selectAll('.node').each(function(d){complicatedView(d);});

    function complicatedView(d) {
        // Funkcija zaduzena za iscrtavanje cvora grafa
        var length = 150;
        var numOfRows = Object.keys(d).length - 6;

        var textSize = 10;
        var height = (numOfRows == 0) ? textSize : numOfRows * textSize + 5;
        height += textSize;

        // Iscrtavanje kvadrata.
        d3.select("g#" + urlToValidId(d.id))
            .append('rect')
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', length)
            .attr('height', height)
            .attr('fill', 'yellow');

        // Prikaz naziva nodea
        d3.select("g#" + urlToValidId(d.id))
            .append('text')
            .attr('x', length / 2)
            .attr('y', 10)
            .attr('text-anchor', 'middle')
            .attr('font-size', textSize)
            .attr('font-family', 'sans-serif')
            .attr('fill', 'black')
            .text(urlToValidName(d.id));

        // Prikaz razdelnika
        d3.select("g#" + urlToValidId(d.id))
            .append('line')
            .attr('x1', 0)
            .attr('y1', textSize + 2)
            .attr('x2', length)
            .attr('y2', textSize + 2)
            .attr('stroke', 'gray')
            .attr('stroke-width', 2);

        var iterationIndex = 0;
        // Iteriranje po kategorijama.Ubacivanje teksta za kategorije
        for (var key in d) {
            if(key === "id"){
                d3.select("g#" + urlToValidId(d.id))
                .append('text')
                .attr('x', 0)
                .attr('y', 20 + iterationIndex * textSize)
                .attr('text-anchor', 'start')
                .attr('font-size', textSize)
                .attr('font-family', 'sans-serif')
                .attr('fill', 'black')
                .text(key + ": " + urlToValidName(d[key]));
            }else if (!["index", "px", "py", "weight", "x", "y"].includes(key)) {
                d3.select("g#" + urlToValidId(d.id))
                    .append('text')
                    .attr('x', 0)
                    .attr('y', 20 + iterationIndex * textSize)
                    .attr('text-anchor', 'start')
                    .attr('font-size', textSize)
                    .attr('font-family', 'sans-serif')
                    .attr('fill', 'black')
                    .text(key + ": " + d[key]);
            }

            iterationIndex++
        }
    }


        function tick(e) {
            // Korak simulacije koji koriguje pozicije cvorova i ivica grafa.

            // translacija cvorova
            node.attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            })
                // Omogucavamo interaktivno prevlacenje cvorova.
                // Vise informacija na
                // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/#drag
                .call(force.drag);

            // Korekcija pozicija ivica (linkova)
            link.attr('x1', function (d) {
                return d.source.x;
            })
                .attr('y1', function (d) {
                    return d.source.y;
                })
                .attr('x2', function (d) {
                    return d.target.x;
                })
                .attr('y2', function (d) {
                    return d.target.y;
                });

        }


</script>
{% endblock %}