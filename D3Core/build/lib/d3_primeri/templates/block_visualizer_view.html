{% extends "base.html" %}
{% block head_sadrzaj %}
<style>

.node {
  cursor: pointer;
  color: #3182bd;

}

.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}

</style>
<script>
    function nodeClick(el){
       alert("ID: "+el.id);
    }
</script>
{% endblock %}
{% block content %}
<div>
    <svg width="500" height="500">
        <title>{{ graph.name() }}</title>

    </svg>
</div>
<script>
    // Cvorovi grafa predstavljalu prodavnice i artikli.
    var nodes = {
        {% for node_id, node in graph.nodes.items() %}
            "{{ node_id }}": parseNodeData("{{ node.data }}", "{{ node_id }}"),
        {% endfor %}
    };

    function parseNodeData(htmlBody, nodeId) {
    var infoboxLabelRegex = /infobox-label[^>]*>([^<]*)</g;
    var infoboxDataRegex = /infobox-data[^>]*>([^<]*)</g;

    var matches = {};
    var labelMatch;
    var counter = 0;
    while ((labelMatch = infoboxLabelRegex.exec(htmlBody)) !== null || counter < 5) {
        var labelText = labelMatch[1].trim();

        // Find infobox-data that comes after the current infobox-label
        var dataMatch = infoboxDataRegex.exec(htmlBody);

        if (dataMatch) {
            counter ++;
            var dataText = dataMatch[1].trim();
            matches[labelText] = dataText;

            // Set the lastIndex of infoboxLabelRegex to continue from the end of the last match
            infoboxLabelRegex.lastIndex = infoboxDataRegex.lastIndex;
        }
    }
    matches["node_id"] = nodeId;

    return matches;
}

    // Ivice grafa povezuju prodavnicu sa artiklom.
    // "source" atribut predstavlja string identifikator prodavnice
    // "traget" atribut predstavlja string identifikator artikla
    var links=[
        {% for edge in graph.edges %}
            {
              source: "{{ edge.source_node.id }}",
              target: "{{ edge.target_node.id }}",}
        {% endfor %}
    ];

    // Za svaki link, "source" atribut se menja tako sto se vrsi zamena
    // string identifikatora prodavnice stvarnim objektom koji se na tu
    // prodavnicu odnosu (nodes[id_prodavnice_kao_kljuc]).
    // Slicno i za "target" atribut.
    links.forEach(function(link) {
        link.source = nodes[link.source];
        link.target = nodes[link.target];
    });

    // Force layout vrsi numericku simulaciju n-tela (n-cestica).
    // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/
    var force = d3.layout.force() // kreiranje force layout-a
        .size([400, 400]) // raspoloziv prostor za iscrtavanje
        .nodes(d3.values(nodes)) // dodavanje informacija o cvorovima grafa
        .links(links) // dodavanje informacije o ivicama grafa
        .on("tick", tick) // Dogadjaj tick okida se prilikokm svakog koraka simulacije.
                          // Tada se poziva dolenavedena "tick" funckija koja koriguje pozicije
                          // elemenata grafa.
                          // Vise informacija mozete pronaci ovde:
                          // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/#tick
        .linkDistance(300) // duzina ivice grafa
        .charge(-100) // koliko da se elementi odbijaju (pozitivna vrednost kaze koliko se elementi privlace)
        .start(); //pokreni simulaciju

    var svg=d3.select('svg');

    // Stvarno iscrtavanje linkova koji su prikazani linijama.
    var link = svg.selectAll('.link')
        .data(links)
        .enter().append('line')
        .attr('class', 'link');

    // Stvarno iscrtavanje cvorova reprezentovanih g tagom.
    var node = svg.selectAll('.node')
        .data(force.nodes()) //add
        .enter().append('g')
        .attr('class', 'node')
        .attr('id', function(d){return d.node_id;})
        .on('click',function(){
           nodeClick(this);
        });

    // Sadrzaj svakog g taga iscrtavamo funkcijom slozenPrikaz.
    d3.selectAll('.node').each(function(d){complicatedView(d);});

    function complicatedView(d){
      // Funkcija zaduzena za iscrtavanje cvora grafa
      var length=150;
      var numOfRows=Object.keys(d).length - 1;

      var textSize=10;
      var height=(numOfRows==0)?textSize:numOfRows*textSize;
      height+=textSize;

      // Iscrtavanje kvadrata.
      d3.select("g#"+d.node_id)
          .append('rect')
          .attr('x',0)
          .attr('y',0)
          .attr('width',length)
          .attr('height',height)
          .attr('fill','yellow');

      // Prikaz naziva nodea
      d3.select("g#"+d.node_id)
          .append('text')
          .attr('x',length/2)
          .attr('y',10)
          .attr('text-anchor','middle')
          .attr('font-size',textSize)
          .attr('font-family','sans-serif')
          .attr('fill','green')
          .text(d.node_id);

      // Prikaz razdelnika
      d3.select("g#"+d.node_id)
          .append('line')
          .attr('x1',0)
          .attr('y1',textSize)
          .attr('x2',length)
          .attr('y2',textSize)
          .attr('stroke','gray')
          .attr('stroke-width',2);

      var iterationIndex = 0;
        // Iteriranje po kategorijama.Ubacivanje teksta za kategorije
        for(var key in d)
        {
            if(key === "node_id"){
                continue;
            }
          // Prikaz naziva kategorije
          d3.select("g#"+d.node_id)
              .append('text')
              .attr('x',0)
              .attr('y',20+iterationIndex*textSize)
              .attr('text-anchor','start')
              .attr('font-size',textSize)
              .attr('font-family','sans-serif')
              .attr('fill','green')
              .text(key + ": " + d[key]);
            iterationIndex++
        }
    }


    function tick(e) {
        // Korak simulacije koji koriguje pozicije cvorova i ivica grafa.

        // translacija cvorova
        node.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        })
            // Omogucavamo interaktivno prevlacenje cvorova.
            // Vise informacija na
            // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/#drag
            .call(force.drag);

        // Korekcija pozicija ivica (linkova)
        link.attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });

    }


</script>
{% endblock %}