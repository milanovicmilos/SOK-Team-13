{% block head_sadrzaj %}
<style>

.node {
  cursor: pointer;
  color: #046ebd;

}

.link {
  fill: none;
  stroke: #046ebd;
  stroke-width: 1.5px;
}

</style>
{% endblock %}
{% block bird_view_content %}
<div>
    <svg id="bird_svg" width="100%" height="669px">
        <rect id="viewport" width="100" height="100" fill="none" stroke="red" stroke-width="2"></rect>
    </svg>
</div>
<script>
    // Cvorovi grafa predstavljalu prodavnice i artikli.
    let nodes1 = {
        {% for  node in graph.nodes %}
            "{{ node.node_id }}": {{ node.parsed_data }},
        {% endfor %}
    };


    function urlToValidId(url) {
        // Replace invalid characters with underscores
        return url.replace(/[^a-zA-Z0-9-_]/g, '_') + '_';
    }

    function urlToValidName(url) {
       const regex = /[^/]*(?:\/([^\/#]+))?(?:#([^#]+))?$/;
        const match = url.match(regex);

        if (match) {
            const [ , lastSegment, fragment ] = match;
            return fragment ? fragment : lastSegment;
        }

        // If there's no match, return the original URL
        return url;
    }


    let links1=[
        {% for edge in graph.edges %}
            {
              source: "{{ edge.source_node.node_id }}",
              target: "{{ edge.target_node.node_id }}"},
        {% endfor %}
    ];

    links1.forEach(function(link) {
        link.source = nodes1[link.source];
        link.target = nodes1[link.target];
    });
    // Force layout vrsi numericku simulaciju n-tela (n-cestica).
    // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/
    let force1 = d3.layout.force() // kreiranje force layout-a
        .size([350, 600]) // raspoloziv prostor za iscrtavanje
        .nodes(d3.values(nodes1)) // dodavanje informacija o cvorovima grafa
        .links(links1) // dodavanje informacije o ivicama grafa
        .on("tick", tick)
        .linkDistance(300) // duzina ivice grafa
        .charge(-100) // koliko da se elementi odbijaju (pozitivna vrednost kaze koliko se elementi privlace)
        .start(); //pokreni simulaciju

    let svg1 = d3.select('#bird_svg') // Selektujemo svg element
    .style('border', '1px solid black') // Add border style
    .append('g'); // Append a group element for content

    // Define the viewBox and preserveAspectRatio attributes for a fixed-size view
    svg1.attr('viewBox', '0 0 600 600')
       .attr('preserveAspectRatio', 'xMidYMid meet');


    // Stletno iscrtavanje linkova koji su prikazani linijama.
    let link1 = svg1.selectAll('.link')
        .data(links1)
        .enter().append('line')
        .attr('class', 'link')
        .attr('x1', function(d) { return d.source.y; })
        .attr('y1', function(d) { return d.source.x; })
        .attr('x2', function(d) { return d.target.y; })
        .attr('y2', function(d) { return d.target.x; });

    // Stletno iscrtavanje cvorova reprezentovanih g tagom.
    let node1 = svg1.selectAll('.node')
        .data(force1.nodes()) //add
        .enter().append('g')
        .attr('class', 'node')
        .attr('id', function(d) { return urlToValidId(d.id); })
        .on('click',function(){
           nodeClick(this);
        });


    // Sadrzaj svakog g taga iscrtavamo funkcijom slozenPrikaz.
    d3.selectAll('.node').each(function(d){complicatedView(d);});

    function complicatedView(d) {
        // Funkcija zaduzena za iscrtavanje cvora grafa
        let length = 20;
        let textSize = 8;
        let height = textSize;

        // Iscrtavanje kruga.
        d3.select("g#" + urlToValidId(d.id))
            .append('circle')
            .attr('r', 10) //radius of circle
            .attr('fill','orange');

        // Prikaz naziva nodea
        d3.select("g#" + urlToValidId(d.id))
            .append('text')
            .attr('x', length / 2)
            .attr('y', 10)
            .attr('text-anchor', 'middle')
            .attr('font-size', textSize)
            .attr('font-family', 'sans-serif')
            .attr('fill', 'black')
            .text(urlToValidName(d.id));
    }


    function tick(e) {
        node1.attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });

        // Remove the drag behavior from node1
        node1.on('.drag', null);

        // Correct link positions
        link1.attr('x1', function (d) {
            return d.source.x;
        })
        .attr('y1', function (d) {
            return d.source.y;
        })
        .attr('x2', function (d) {
            return d.target.x;
        })
        .attr('y2', function (d) {
            return d.target.y;
        });
    }

    let viewport = d3.select('#viewport');

    // Update the viewport that surround visible nodes
    function update_viewport(visible_nodes) {

        let bird_visible_nodes = [];
        visible_nodes.forEach(function(node) {
            d3.selectAll('.node').each(function(d){
                if (d.id === node.id) {
                    bird_visible_nodes.push(d);
                }
            });
        });



        let minX = d3.min(bird_visible_nodes, function(d) { return d.x; });
        let minY = d3.min(bird_visible_nodes, function(d) { return d.y; });
        let maxX = d3.max(bird_visible_nodes, function(d) { return d.x; });
        let maxY = d3.max(bird_visible_nodes, function(d) { return d.y; });

        let width = maxX - minX;
        let height = maxY - minY;

        viewport.attr('x', minX)
            .attr('y', minY)
            .attr('width', width)
            .attr('height', height);
    }

</script>
{% endblock %}